<div class="play-wrap safe-bottom">
  @if (store.canFullAutoSolve()) {
  <div class="solve-strip">
    <button
      class="ghost"
      mat-stroked-button
      (click)="openSolveConfirm()"
    >
      <mat-icon>psychology</mat-icon>
      <span>Auto-solve</span>
    </button>
  </div>
  }

  <div class="hud">
    <div class="cell left">
      <div
        class="hud-item score"
        [class.bump]="store.scoreBump()"
      >{{ store.score() }}</div>
    </div>
    <div class="cell center">
      <div class="hud-item diff">{{ (store.rating()?.bucket || '—') | titlecase }}</div>
    </div>
    <div class="cell right">
      <div class="hud-item time">{{ store.timerLabel() }}</div>
      <button
        class="hud-item pause"
        mat-icon-button
        (click)="openPause()"
        aria-label="Pause"
      >
        <mat-icon>pause</mat-icon>
      </button>
    </div>
  </div>

  <div class="board-wrap">
    <app-board></app-board>

    <!-- hide the fly-in during review mode -->
    @if (!store.reviewMode() && store.autoFillOfferVisible()) {
    <div class="under-board-layer">
      <div
        class="auto-fill-flyin"
        role="status"
        aria-live="polite"
        [class.closing]="closingAutoFill"
        (animationend)="onAutoFillAnimEnd($event)"
      >
        <button
          class="cta"
          mat-flat-button
          color="primary"
          (click)="store.autoFillRemaining()"
        >
          <mat-icon>bolt</mat-icon>
          <span>Finish last numbers</span>
        </button>
        <button
          class="dismiss"
          mat-icon-button
          aria-label="Not now"
          (click)="dismissAutoFillFlyin()"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    }
  </div>

  <!-- Start Solving bar (given mode only) -->
  @if (store.editingGivenMode()) {
  <div
    class="start-bar"
    role="region"
    aria-label="Start solving"
  >
    <div class="msg">
      Setup mode — tap Start when you’ve finished entering givens.
      @if (!store.hasAnyValues()) { <span class="warn">Please enter at least one value to begin.</span> }
      @if (store.conflicts().cells.size) { <span class="warn">There are conflicts in the givens.</span> }
    </div>
    <button
      mat-flat-button
      color="primary"
      class="start-btn"
      (click)="startSolving()
      "
      [disabled]="!store.hasAnyValues() || store.conflicts().cells.size > 0"
    >Start</button>
  </div>
  }

  <!-- Tools & keypad are hidden in review mode -->
  @if (!store.reviewMode()) {
  <div
    class="tools"
    role="toolbar"
    aria-label="Board tools"
  >
    <button
      class="tool ghost tool--reset"
      type="button"
      (click)="store.resetPencils()"
      aria-label="Reset pencils"
    >
      <mat-icon class="ic">layers_clear</mat-icon>
      <span class="lbl">Reset Pencils</span>
    </button>

    <button
      class="tool ghost tool--undo"
      type="button"
      (click)="undo()"
      aria-label="Undo"
    >
      <mat-icon class="ic">undo</mat-icon>
      <span class="lbl">Undo</span>
    </button>

    <button
      class="tool ghost tool--erase"
      type="button"
      (click)="erase()"
      aria-label="Erase"
    >
      <mat-icon class="ic">backspace</mat-icon>
      <span class="lbl">Erase</span>
    </button>

    <button
      class="tool ghost tool--pencil"
      type="button"
      (click)="togglePencil()"
      [attr.aria-pressed]="store.pencilMode()"
    >
      <mat-icon class="ic">edit_note</mat-icon>
      <span class="lbl">Pencil</span>
      <span
        class="badge"
        [class.on]="store.pencilMode()"
      >{{ store.pencilMode() ? 'ON' : 'OFF' }}</span>
    </button>

    <button
      class="tool ghost tool--hint"
      type="button"
      (click)="openHint()"
      aria-label="Hint"
    >
      <mat-icon class="ic">lightbulb</mat-icon>
      <span class="lbl">Hint</span>
    </button>
  </div>

  <app-number-pad class="pad"></app-number-pad>

  <div
    class="ad-reserve"
    aria-hidden="true"
  ></div>
  } @else {
  <!-- Review CTA replaces tools & keypad -->
  <div
    class="review-cta"
    role="status"
    aria-live="polite"
  >
    <div class="badge">Review mode — read-only</div>
    <button
      mat-flat-button
      color="primary"
      (click)="goDashboard()"
    >Go to Dashboard</button>
  </div>
  }
</div>
